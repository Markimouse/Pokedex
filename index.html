<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokedex Card Collector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Set Firebase log level to debug for better console output
        setLogLevel('Debug');

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhnSMCnVP1aB3i76Sbx1AIXKdzpva_428",
            authDomain: "pokedex-5df8e.firebaseapp.com",
            projectId: "pokedex-5df8e",
            storageBucket: "pokedex-5df8e.firebasestorage.app",
            messagingSenderId: "93348869700",
            appId: "1:93348869700:web:d0669fbd08ea16c3aeee11",
            measurementId: "G-X3GD2XY8VC"
        };
        const initialAuthToken = null; // Set to null for local use.

        let app;
        let db;
        let auth;
        let userId = null;
        let pokemonData = [];
        let collectedCards = {};
        let generationsData = [];

        // Rarity options and symbols
        const RARITIES = ['Common', 'Uncommon', 'Rare', 'Double Rare', 'Holo Rare', 'Reverse Holo', 'Illustration Rare', 'Special Illustration Rare', 'Hyper Rare', 'Ultra Rare', 'Secret Rare', 'Gold'];
        const raritySymbols = {
            'Common': '●',
            'Uncommon': '◆',
            'Rare': '★',
            'Double Rare': '★★',
            'Holo Rare': '★',
            'Reverse Holo': '★',
            'Illustration Rare': '★',
            'Special Illustration Rare': '★★',
            'Hyper Rare': '★★★',
            'Ultra Rare': '☆☆',
            'Secret Rare': '★',
            'Gold': '★'
        };

        // Function to create a message box instead of using alert()
        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="p-3 mb-4 rounded-lg text-sm text-center font-medium ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Initialize Firebase and set up authentication
        function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                        
                        await fetchPokemonData();
                        setupRealtimeListener();
                    } else {
                        // If no user, and we have an initial token, sign in with it.
                        // Otherwise, sign in anonymously for local testing.
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            if (error.code === 'auth/configuration-not-found') {
                                showMessage("Firebase Auth is not enabled for this project. Please go to the Firebase Console, navigate to 'Authentication', and enable the 'Anonymous' sign-in method.", 'error');
                            } else {
                                showMessage("Failed to authenticate. Please try again.", 'error');
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-text').textContent = "Firebase initialization failed. Check your console for details.";
            }
        }

        // Fetch all Pokémon data and generation data from PokeAPI
        async function fetchPokemonData() {
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = 'Loading Pokémon data... This may take a moment.';
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');

            try {
                // Fetch generation data first
                const genResponse = await fetch('https://pokeapi.co/api/v2/generation/');
                const genData = await genResponse.json();
                generationsData = genData.results;
                
                // Get the last Pokemon ID for each generation
                const genDetailsPromises = generationsData.map(gen => fetch(gen.url).then(res => res.json()));
                const genDetails = await Promise.all(genDetailsPromises);
                
                // Transform generation data for easy lookup
                generationsData = genDetails.map(gen => {
                    const sortedPokemon = gen.pokemon_species.map(p => {
                        const id = p.url.split('/').slice(-2, -1)[0];
                        return parseInt(id);
                    }).sort((a, b) => a - b);
                    return {
                        name: gen.name,
                        start: sortedPokemon[0],
                        end: sortedPokemon[sortedPokemon.length - 1]
                    };
                });

                // Populate the generation filter dropdown
                const genFilter = document.getElementById('generation-filter');
                genFilter.innerHTML = `<option value="">-- All Generations --</option>` + generationsData.map(gen => {
                    const genNumber = gen.name.split('-')[1].toUpperCase();
                    return `<option value="${gen.name}">Generation ${genNumber} (${gen.start}-${gen.end})</option>`;
                }).join('');
                
                // Populate the rarity filter dropdown
                const rarityFilter = document.getElementById('rarity-filter');
                rarityFilter.innerHTML = `<option value="">-- All Rarities --</option>` + RARITIES.map(rarity => `<option value="${rarity}">${raritySymbols[rarity]} ${rarity}</option>`).join('');

                // Fetch the list of all Pokémon (1025 Pokémon total)
                const response = await fetch('https://pokeapi.co/api/v2/pokemon?limit=1025');
                const data = await response.json();
                
                // Fetch details for each Pokémon concurrently
                const pokemonDetailsPromises = data.results.map(pokemon => fetch(pokemon.url).then(res => res.json()));
                const allDetails = await Promise.all(pokemonDetailsPromises);

                pokemonData = allDetails.map(detail => ({
                    id: detail.id,
                    name: detail.name,
                    imageUrl: detail.sprites.front_default,
                    types: detail.types.map(t => t.type.name),
                }));
                
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                renderPokemonList();
            } catch (error) {
                console.error("Error fetching Pokémon data:", error);
                loadingText.textContent = 'Failed to load Pokémon data.';
            }
        }

        // Set up the real-time Firestore listener for the user's collection
        function setupRealtimeListener() {
            const collectionPath = `artifacts/${appId}/users/${userId}/pokemon_cards`;
            const q = collection(db, collectionPath);
            onSnapshot(q, (snapshot) => {
                collectedCards = {};
                snapshot.forEach(doc => {
                    const card = doc.data();
                    if (card.rarities) {
                        // Store the array of rarities
                        collectedCards[card.id] = card.rarities;
                    }
                });
                renderPokemonList();
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showMessage("Failed to load your collection. Check your connection.", 'error');
            });
        }

        // Handle rarity button clicks and save to Firestore
        async function handleRarityClick(pokemonId, toggledRarity) {
            if (!userId) {
                showMessage('Please wait for authentication to complete.', 'error');
                return;
            }

            const pokemon = pokemonData.find(p => p.id === parseInt(pokemonId));
            if (!pokemon) return;

            const collectionPath = `artifacts/${appId}/users/${userId}/pokemon_cards`;
            const cardRef = doc(db, collectionPath, pokemonId.toString());

            let currentRarities = collectedCards[pokemonId] || [];
            let newRarities;

            // Check if the toggled rarity is already in the array
            if (currentRarities.includes(toggledRarity)) {
                // Remove the rarity from the array
                newRarities = currentRarities.filter(r => r !== toggledRarity);
                showMessage(`Removed ${toggledRarity} for ${pokemon.name}.`, 'info');
            } else {
                // Add the new rarity to the array
                newRarities = [...currentRarities, toggledRarity];
                showMessage(`Added ${toggledRarity} for ${pokemon.name}.`, 'info');
            }

            try {
                if (newRarities.length === 0) {
                    // If no rarities are selected, remove the document
                    await setDoc(cardRef, { collected: false });
                } else {
                    // Otherwise, update the document with the new rarities array
                    await setDoc(cardRef, {
                        id: pokemon.id,
                        name: pokemon.name,
                        rarities: newRarities,
                    }, { merge: true });
                }
            } catch (e) {
                console.error("Error updating document: ", e);
                showMessage(`Failed to update ${pokemon.name}'s rarities.`, 'error');
            }
        }

        // Render the Pokémon list to the UI with filters
        function renderPokemonList() {
            const container = document.getElementById('pokemon-list');
            const searchValue = document.getElementById('search-input').value.toLowerCase();
            const selectedRarity = document.getElementById('rarity-filter').value;
            const selectedGen = document.getElementById('generation-filter').value;

            const generationRange = selectedGen ? generationsData.find(gen => gen.name === selectedGen) : null;

            const filteredPokemon = pokemonData.filter(p => {
                const matchesSearch = p.name.includes(searchValue);
                const matchesRarity = !selectedRarity || (collectedCards[p.id] && collectedCards[p.id].includes(selectedRarity));
                const matchesGen = !generationRange || (p.id >= generationRange.start && p.id <= generationRange.end);
                return matchesSearch && matchesRarity && matchesGen;
            });

            if (filteredPokemon.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-10">No Pokémon found matching your criteria.</p>`;
                return;
            }

            container.innerHTML = '';
            filteredPokemon.forEach(pokemon => {
                const currentRarities = collectedCards[pokemon.id] || [];
                const isCollected = currentRarities.length > 0;
                const cardCollectedClass = isCollected ? 'border-green-400 bg-green-50' : 'border-gray-200';
                
                const card = document.createElement('div');
                card.className = `pokemon-card p-4 bg-white rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 ${cardCollectedClass}`;
                
                card.innerHTML = `
                    <div class="flex items-center justify-between cursor-pointer" data-pokemon-id="${pokemon.id}">
                        <div class="flex flex-col items-center flex-grow">
                            <img src="${pokemon.imageUrl}" alt="${pokemon.name}" class="w-24 h-24 mb-2">
                            <h3 class="text-lg font-semibold text-gray-800 capitalize mb-1">${pokemon.name}</h3>
                            <p class="text-sm text-gray-500">#${pokemon.id}</p>
                        </div>
                        <svg class="w-6 h-6 text-gray-400 transition-transform duration-300" data-arrow-svg="${pokemon.id}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div id="rarity-container-${pokemon.id}" class="mt-4 w-full grid grid-cols-2 gap-2 hidden">
                        ${RARITIES.map(rarity => {
                            const isSelected = currentRarities.includes(rarity);
                            const selectedClass = isSelected ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800';
                            const symbol = raritySymbols[rarity];
                            return `<button data-pokemon-id="${pokemon.id}" data-rarity="${rarity}" class="rarity-btn px-2 py-1 text-xs font-medium rounded-full transition-colors duration-200 ${selectedClass}">${symbol} ${rarity}</button>`;
                        }).join('')}
                    </div>
                `;

                // Add a click listener to the entire card to toggle the rarity container
                card.addEventListener('click', (e) => {
                    // Check if the click was on a rarity button to prevent collapsing
                    if (e.target.classList.contains('rarity-btn')) {
                        return;
                    }

                    const rarityContainer = document.getElementById(`rarity-container-${pokemon.id}`);
                    const arrowSvg = document.querySelector(`[data-arrow-svg="${pokemon.id}"]`);
                    
                    rarityContainer.classList.toggle('hidden');
                    arrowSvg.classList.toggle('rotate-180');
                });
                
                card.querySelectorAll('.rarity-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        handleRarityClick(e.target.dataset.pokemonId, e.target.dataset.rarity);
                    });
                });

                container.appendChild(card);
            });
        }

        // Event listeners for the search input and rarity/generation filters
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const rarityFilter = document.getElementById('rarity-filter');
            const generationFilter = document.getElementById('generation-filter');
            searchInput.addEventListener('input', renderPokemonList);
            rarityFilter.addEventListener('change', renderPokemonList);
            generationFilter.addEventListener('change', renderPokemonList);
            
            // Call the initialization function when the DOM is loaded
            initializeAppAndAuth();
        });

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .pokemon-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        .pokemon-card select {
            border: 1px solid #d1d5db;
        }
        .pokemon-card select:focus {
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-6 lg:p-8">
    <div id="app-container" class="hidden max-w-6xl mx-auto w-full">
        <div class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2">Pokedex Collector</h1>
            <p class="text-gray-600 text-lg">Keep track of your Pokémon card collection!</p>
            <p id="user-id-display" class="text-sm text-gray-500 mt-2 break-all"></p>
        </div>

        <div id="message-container" class="fixed top-4 right-4 z-50"></div>

        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <input type="text" id="search-input" placeholder="Search for a Pokémon..." class="w-full sm:w-1/3 px-4 py-3 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
            <select id="rarity-filter" class="w-full sm:w-1/3 px-4 py-3 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                <!-- Rarity options will be populated here by JavaScript -->
            </select>
            <select id="generation-filter" class="w-full sm:w-1/3 px-4 py-3 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                <!-- Generation options will be populated here by JavaScript -->
            </select>
        </div>
        
        <div id="pokemon-list" class="pokemon-list">
            <!-- Pokémon cards will be rendered here by JavaScript -->
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="flex flex-col items-center justify-center min-h-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
        <p id="loading-text" class="mt-4 text-gray-600">Loading app...</p>
    </div>

</body>
</html>
